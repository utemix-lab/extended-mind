# Архитектура системы

> **Один граф — три интерфейса — единый источник истины**

---

## Обзор

Система построена на принципе **единого графа знаний** (Universe Graph), который является источником истины для всех компонентов. Три интерфейса работают с этим графом на разных этапах:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    extended-mind (Редактор)                         │
│                         Онтология + Сценография                     │
│                                                                     │
│   • Создание и редактирование узлов/рёбер                          │
│   • Наполнение 3S контентом (Story/System/Service)                 │
│   • Источник истины для всей системы                               │
│   • В будущем: RAG + LLM для автоматизации                         │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ universe.json
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Godot (Режиссура) — опционально                │
│                                                                     │
│   • Визуальное редактирование маршрутов                            │
│   • Навигация по графу                                             │
│   • Поиск паттернов UI-сценографии                                 │
│   • "Строительные леса" — убираются когда паттерны найдены         │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              │ universe.json (тот же файл)
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      dream-graph (Рендер)                           │
│                                                                     │
│   • Финальная визуализация для пользователя                        │
│   • 3D граф с физикой и звуком                                     │
│   • Панели Story/System/Service                                    │
│   • Публикуется на GitHub Pages / сервер                           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Ключевые принципы

### 1. Единый источник истины

**universe.json** — единственный файл, содержащий:
- Структуру графа (узлы и рёбра)
- Контент для отображения (3S)
- Позиции узлов

Все интерфейсы читают этот файл **напрямую и независимо**.

### 2. Модульность без зависимостей

```
extended-mind ──┐
                ├──► universe.json ◄──┬── dream-graph
Godot ──────────┘                     │
                                      └── (любой будущий рендер)
```

- Godot не является обязательным звеном
- dream-graph работает без Godot
- Можно добавлять новые интерфейсы

### 3. Эволюционная архитектура

**Фаза 1 (сейчас):** Ручное создание
- Человек редактирует граф в editor.html
- Godot помогает найти паттерны

**Фаза 2 (переходная):** Гибридный режим
- Простые изменения — напрямую в editor
- Сложная режиссура — через Godot

**Фаза 3 (целевая):** Автоматизация
- RAG/LLM в extended-mind генерирует контент
- Godot не нужен, убирается из цепочки
- Человек только корректирует

---

## Компоненты

### extended-mind

**Роль:** Хранитель канонического графа

**Компоненты:**
- `contracts/public/graph/editor.html` — визуальный редактор
- `contracts/public/graph/universe.json` — данные графа

**Будущее:**
- RAG для семантического поиска по графу
- LLM для генерации 3S контента
- Автоматическая валидация связности

### contracts

**Роль:** Хранилище данных и ассетов

**Структура:**
```
contracts/public/
├── graph/
│   ├── universe.json      # Граф (источник истины)
│   └── editor.html        # Редактор
├── assets/                # Изображения, иконки, лого
└── texts/                 # Markdown тексты
```

### Godot (godot-sandbox)

**Роль:** Инструмент режиссуры (опциональный)

**Возможности:**
- Визуальная навигация по графу
- Предпросмотр 3S панелей
- Экспорт в route.json

**Статус:** Строительные леса — убираются когда не нужны

### dream-graph

**Роль:** Финальный рендер

**Возможности:**
- 3D визуализация графа
- Физика узлов (пружины, затухание)
- Звуковая обратная связь
- Панели Story/System/Service
- Навигация по узлам

**Технологии:** Three.js, 3d-force-graph, Vite

---

## Формат данных

### universe.json

```json
{
  "meta": {
    "version": "1.0",
    "description": "Universe Graph — канон системы"
  },
  "nodes": [
    {
      "id": "universe",
      "label": "Universe",
      "position": { "x": 400, "y": 300 },
      "story": "Текст для панели Story",
      "system": "Текст для панели System", 
      "service": "Текст для панели Service"
    }
  ],
  "edges": [
    {
      "id": "edge-1",
      "source": "universe",
      "target": "concept-a"
    }
  ]
}
```

### Поля узла

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | string | Уникальный идентификатор |
| `label` | string | Отображаемое имя |
| `position` | {x, y} | Позиция в редакторе |
| `story` | string | Нарративный контент |
| `system` | string | Техническое описание |
| `service` | string | Действия и возможности |

---

## Рабочий процесс

### Создание контента

1. **Открыть редактор:**
   ```
   contracts/public/graph/editor.html
   ```

2. **Редактировать граф:**
   - Добавить узлы (+ Node)
   - Соединить рёбрами (+ Edge)
   - Заполнить Story/System/Service

3. **Сохранить:**
   - Save JSON → скачивается universe.json
   - Положить в `contracts/public/graph/`

4. **Проверить в dream-graph:**
   ```
   http://localhost:5173/dream-graph/visitor.html
   ```
   - Нажать Reload для обновления

### Без Godot (простой путь)

```
editor.html → Save → universe.json → dream-graph
```

### С Godot (расширенный путь)

```
editor.html → Save → universe.json → Godot (F5) → проверка → dream-graph
```

---

## Перспективы

### Ближайшие

- [ ] RAG-индексация графа в extended-mind
- [ ] Автодополнение 3S контента через LLM
- [ ] Валидация связности графа

### Долгосрочные

- [ ] Граф становится базой знаний системы
- [ ] LLM понимает и структуру, и сценографию
- [ ] Автоматическая генерация маршрутов
- [ ] Godot полностью заменяется автоматикой

---

## Репозитории экосистемы

| Репозиторий | Роль | Статус |
|-------------|------|--------|
| **extended-mind** | Канон, RAG, документация | Активный |
| **contracts** | Данные, ассеты | Активный |
| **dream-graph** | Финальный рендер | Активный |
| **godot-sandbox** | Режиссура (опц.) | Строительные леса |
| **vovaipetrova-core** | Архив контента | Read-only |
| **utemix-lab** | Мета-репо, координация | Активный |

---

## FAQ

**Q: Зачем три интерфейса, если можно один?**

A: Разделение ответственности. Редактирование, режиссура и рендер — разные задачи с разными требованиями. При этом данные общие.

**Q: Что если Godot не нужен?**

A: Просто не используй его. Цепочка extended-mind → dream-graph работает напрямую.

**Q: Как добавить новый рендер?**

A: Создай компонент, который читает universe.json. Формат документирован, зависимостей нет.

**Q: Где хранится "истина"?**

A: В `contracts/public/graph/universe.json`. Это единственный источник.
