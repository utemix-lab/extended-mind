---
title: RAG Indexing Specification v0.1
version: 0.1
type: spec
status: draft-core
tags: [rag, indexing, chunking, taxonomy]
lastmod: 2025-12-16
description: "Правила индексирования документов extended-mind в RAG v0.1: какие сущности попадают в индекс, как они режутся на чанки и маркируются."
---

# RAG Indexing Specification v0.1

Этот документ описывает, **как extended-mind превращает свои файлы в индекс**:

- какие сущности индексируются,
- как определяется их тип,
- как они нарезаются на чанки,
- как маркируются метаданными.

---

## 1. Единицы индексирования

Extended-mind различает три уровня:

1. **Файл (document)**  
   - физический `.md`  
   - имеет `frontmatter`  
   - пример: `docs/adr/adr-0003-rag-first.md`

2. **Логический блок (section)**  
   - фрагмент внутри файла  
   - определяется заголовками `#`, `##`, `###`

3. **Чанк (chunk)**  
   - финальная единица для RAG  
   - может включать один или несколько логических блоков  
   - обладает:
     - текстом,
     - метаданными,
     - эмбеддингом.

---

## 2. Типы индексируемых файлов

Типы берутся из `frontmatter.type`.  

В v0.1 индексируются:

- `definition`
- `principle`
- `manifest`
- `adr`
- `pattern`
- `project`
- `concept-map`
- `core`
- `story-index`

**Не индексируются:**

- `story-node` (сырые story-узлы),
- любые файлы без типа (до явного решения).

---

## 3. Роль тегов (tags)

Теги (`tags` в фронтматтере):

- описывают **темы** и **мир**, к которому относится сущность,
- помогают фильтровать запросы.

Примеры тегов:

- `extended-mind`
- `story-layer`
- `vova-and-petrova`
- `thin-tank`
- `rag`
- `graph`
- `architecture`
- `author-line`
- `machine-log`

Правило:

> Каждый индексируемый файл **должен иметь хотя бы один тег**.

---

## 4. Правила чанкования

### 4.1. Основная идея

Чанк должен быть:

- достаточно большим, чтобы не потерять мысль,
- достаточно маленьким, чтобы быть прицельным.

### 4.2. Алгоритм

1. Разбить документ по заголовкам `#`, `##`, `###`.  
2. Внутри каждого сегмента собрать текст до размера:
   - `chunk_size ≈ 600–1000 токенов`,
   - с overlap `≈ 150–200 токенов`.

3. Если сегмент слишком маленький (`< min_chunk_size`),  
   - объединить его с соседним по смыслу.

4. Если сегмент слишком большой,  
   - разрезать внутри по:
     - пустым строкам,
     - крупным спискам.

---

## 5. Специальные правила для ADR и паттернов

### 5.1. ADR

Структура ADR обычно такова:

- Context
- Decision
- Consequences

Правило:

- по возможности делать **отдельный чанк на каждый из этих разделов**,  
- чтобы:

  - можно было искать “контекст решения”,
  - отдельно — “формулировку решения”.

### 5.2. Patterns

Структура:

- Problem
- Pattern
- Steps
- Examples / Notes

Правило:

- `Problem + Pattern` можно объединять,  
- `Steps` желательно держать отдельным чанком.

---

## 6. Связь с онтологиями и проектами

Каждый чанк должен знать:

- к какому **проекту** он относится (если применимо),
- к какому **миру/слою**:
  - `extended-mind`,
  - `vova-and-petrova`,
  - `evoquant`,
  - `word-machine`,
  - `story-layer`.

Это можно реализовать:

- либо через `tags`,
- либо через отдельное поле `project`.

---

## 7. Обновление индекса

В v0.1:

- ingestion перезаписывает индекс целиком,
- изменения в документах → полная переиндексация.

Требование:

- отсутствие “висячих” чанков от удалённых файлов,
- пересоздание эмбеддингов при изменении текста.

---

## 8. Статус

Этот документ — операционная база для ingestion и поддержания RAG.  
Он обеспечивает:

- предсказуемость поведения,
- стабильность поиска,
- аккуратность “памяти” extended-mind.
