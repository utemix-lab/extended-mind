---
title: RAG Ingestion Plan — Extended-mind v0.1
version: 0.1
type: process
status: draft-core
tags: [rag, ingestion, pipeline]
lastmod: 2025-12-13
description: "Пошаговый план: как собирать файлы extended-mind, превращать их в чанки и загружать в векторный индекс."
---

# RAG Ingestion Plan — Extended-mind v0.1

---

## 1. Цель ingestion v0.1

Сделать минимальный, но живой пайплайн:

> “GitHub-репозиторий extended-mind → локальная директория → чанкование → эмбеддинги → векторный индекс”.

При этом:

- Чётко ограничить, какие файлы попадают в индекс.
- Сразу заложить структуру метаданных.
- Сделать так, чтобы автор мог:
  - перезапустить ingestion без страха “сломать всё”,
  - постепенно подключать новые папки.

---

## 2. Диапазон документов v0.1

### 2.1. Включаем

Из директории `docs/`:

- `definitions/**/*.md`
- `principles/**/*.md`
- `manifest/**/*.md`
- `adr/**/*.md`
- `patterns/**/*.md`
- `projects/**/*.md`
- `concepts/**/*.md`
- `core/system-prompt.md`
- `story-layer/index.md`

### 2.2. Не включаем (v0.1)

- `docs/story-layer/author-line/**`
- `docs/story-layer/nodes/**`
- `docs/story-layer/machine-log/**`
- любые файлы со статусом:
  - `status: draft-raw`
  - `status: private`

---

## 3. Структура ingestion-скриптов

### 3.1. Файлы в репозитории

В корне extended-mind (или в `tools/`) появляются:

- `rag/ingest.py` — основной скрипт ingestion.
- `rag/config.yaml` — настройки:
  - пути к папкам,
  - фильтры по `type` и `status`,
  - параметры чанкования.
- `rag/index-info.json` — служебная информация:
  - дата последнего обновления,
  - количество документов/чанков.

(Названия файлов — ориентировочные, можно менять.)

---

## 4. Шаги пайплайна

### Шаг 1 — Сканирование файловой системы

1. Пройти по всем указанным в `config.yaml` директориям.
2. Для каждого `.md`:
   - прочитать frontmatter,
   - проверить:
     - `type` ∈ допустимом списке,
     - `status` ∉ `draft-raw` / `private`.

3. Сформировать список документов для индексации:
   - `source_path`,
   - `frontmatter`,
   - `raw_body`.

### Шаг 2 — Очистка и предварительная обработка текста

Для каждого документа:

- удалить frontmatter из текста (но сохранить его отдельно как метаданные),
- при желании:
  - очистить служебные маркеры,
  - нормализовать переносы строк.

Важно:

- **не трогать семантику**,
- не стирать заголовки и списки — они помогают при чанковании.

### Шаг 3 — Чанкование

Алгоритм v0.1:

- разбить документ по заголовкам `#`, `##`, `###`,
- внутри сегментов:
  - склеивать текст до целевого размера чанка (600–1000 токенов),
  - перекрытие между чанками ~150–200 токенов.

Каждый чанк получает:

- `chunk_id`
- `doc_id`
- `title` (из документа)
- `type`, `tags`, `status`, `lastmod`
- `source_path`
- `chunk_text`

### Шаг 4 — Генерация эмбеддингов

Для каждого чанка:

- текст → эмбеддинг через выбранную модель (`sentence-transformers` и т.п.).

Сторона реализации:

- отдельный Python-модуль `embeddings.py`,
- возможность сменить модель через `config.yaml`.

### Шаг 5 — Загрузка в векторный индекс

Для каждого чанка:

- записать:
  - вектор (эмбеддинг),
  - метаданные,
  - идентификаторы.

При повторном запуске ingestion:

- опция:
  - **полная перезагрузка индекса** (для простоты v0.1),
  - либо обновление только изменённых документов (v0.2+).

---

## 5. Частота обновления

На этапе v0.1:

- ingestion запускается **вручную**:
  - автор вносит изменения в документы,
  - в какой-то момент запускает `python rag/ingest.py`.

В будущем:

- можно добавить GitHub Actions / cron на VPS,
- но сейчас важна **прозрачность и контроль**, а не автоматизм.

---

## 6. Логирование и контроль

- по окончании ingestion выводится:
  - количество документов,
  - количество чанков,
  - время генерации.

- в `rag/index-info.json` можно хранить:
  - список проиндексированных файлов,
  - суммарную статистику,
  - версию стека.

---

## 7. Связь с режимами использования

Этот ingestion-план поддерживает три режима:

1. **Учитель для автора**
   - быстрый поиск по ADR, определениям, паттернам.

2. **Компас для проектов**
   - retrieval по проектам (V&P, evoquant, word-machine).

3. **Архитектор**
   - поиск по предыдущим решениям и картам смыслов.

---

## 8. Статус

v0.1 — достаточен для запуска первого рабочего RAG.  
Дальше планируется:

- отдельный ingestion для story-layer,
- добавление версионности и частичного обновления индекса.
