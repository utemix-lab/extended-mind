---
title: RAG Architecture — Extended-mind v0.1
version: 0.1
type: architecture
status: draft-core
tags: [rag, retrieval, architecture, extended-mind]
lastmod: 2025-12-11
description: "Первый набросок архитектуры RAG для extended-mind: коллекции, чанкование, метаданные, стратегии извлечения."
---

# RAG Architecture — Extended-mind v0.1

Этот документ описывает первый, предельно простой вариант RAG для extended-mind.  
Цель — сделать рабочий прототип, а не идеальную систему.  
Графы, сложная маршрутизация и прочая магия — позже (см. ADR-0003: RAG first, graph later).

---

## 1. Задачи RAG в extended-mind

RAG для extended-mind должен:

1. **Поддерживать память системы**  
   - позволять extended-mind “помнить” уже принятые решения, определения, паттерны.

2. **Переводить story-layer в структуру**  
   - помогать вытягивать из story-node тезисы и линии,
   - не давая сырому тексту напрямую управлять архитектурой.

3. **Быть учителем автора**  
   - быстро подсказывать:
     - определения,
     - паттерны действий,
     - принятые решения (ADR),
     - описания проектов и их границы.

4. **Служить базой для V&P и других проектов**  
   - extended-mind должен уметь отвечать на вопросы по:
     - архитектуре V&P,
     - принципам thin-tank,
     - ролям персонажей и т.п.

---

## 2. Объём v0.1 (что в индекс, а что нет)

На этапе v0.1 в RAG попадает не всё.

### 2.1. Включаем в индекс

- `docs/definitions/*.md`  
  - все определения, включая `definition-pack-v0.1.md`.

- `docs/principles/*.md`  
  - принципы честности, анти-спекулятивности, структура/хаос и т.д.

- `docs/manifest/*.md`  
  - как extended-mind мыслит, какие роли у автора и машины.

- `docs/adr/*.md`  
  - все ADR, в т.ч.:
    - ADR-0003 — RAG first, graph later
    - ADR-0007 — Story-layer separation
    - ADR-0008 — Role of Definition Pack
    - ADR-0011 — Separation of Author-line and Machine-log
    - ADR-0012 — What Cannot Be Automated

- `docs/patterns/*.md`
  - трансформации:
    - storynode-to-thesis,
    - thesis-decomposition,
    - line-consolidation,
    - project-framing,
    - bias-detection и т.п.

- `docs/projects/**/*.md`
  - overview-проекты (extended-mind, V&P и др.),
  - но **без** сырых заметок.

- `docs/concepts/*.md`
  - concept maps v0.1.

- `docs/core/system-prompt.md`
  - ядро поведения extended-mind.

- `docs/story-layer/index.md`
  - правила обращения со story-layer.

### 2.2. Не включаем (пока) в индекс

- сами `story-node` (сырьё),
- полный machine-log (отчёты чатов, длинные протоколы),
- черновики без статуса (`status: draft-raw`).

Story-layer и сырые журналы:
- используются для ручной работы,
- могут позже иметь свои отдельные индексы,
- но в v0.1 RAG-фокус — на **структуре**, а не на хаосе.

---

## 3. Модель данных и чанкование

### 3.1. Формат документа

Extended-mind уже использует **frontmatter** вида:

```yaml
---
title: ...
version: ...
type: ...
status: ...
tags: [...]
lastmod: ...
description: ...
---
Это превращается в метаданные чанков:

title

type

status

tags

lastmod

source_path

3.2. Чанкование v0.1
Простой, “универсальный” вариант:

размер чанка: ~600–1000 токенов,

пересечение чанков: ~150–200 токенов,

разрезы по:

заголовкам (#, ##, ###),

логическим блокам списков.

Отдельно стоит обработать:

ADR — желательно цельным чанкованием по разделам:

Context / Decision / Consequences.

Паттерны — по разделам:

Problem / Pattern / Steps / Examples.

4. Структура индекса v0.1
Чтобы не уходить в ранний оверинжиниринг,
делаем один общий индекс с метаданными, но с “быстрыми дорожками”:

4.1. Один векторный индекс
Все включённые документы → один общий векторный индекс (например, extended_mind_main).

4.2. Логические “подколлекции” (через метаданные и фильтры)
На уровне кода:

collection = 'definitions' → type: definition

collection = 'adr' → type: adr

collection = 'patterns' → type: pattern

collection = 'projects' → type: project

collection = 'concepts' → type: concept-map

collection = 'core' → type: core

Физически это один индекс,
но при запросе мы можем фильтровать по type и tags.

5. Стратегии извлечения (retrieval)
5.1. Базовый сценарий: “один запрос — один ответ”
Пользователь задаёт вопрос (в чате с extended-mind).

Перед retrieval:

попытаться понять, что за вопрос:

“что это?” → definitions + concepts,

“почему так?” → ADR + principles + manifest,

“как делать?” → patterns + projects,

“что за V&P / thin-tank?” → projects + concepts.

В зависимости от типа:

ставим приоритеты:

definitions: повышенный вес, маленький top-k,

ADR: высокий приоритет для “почему/зачем”,

patterns: при “как”.

В v0.1 это можно сделать даже без сложной классификации —
через простые эвристики и ручные фильтры.

5.2. Top-k и ранжирование
top_k по умолчанию: 8–12 чанков.

Можно:

чуть повышать вес более свежих документов (lastmod),

фильтровать по status:

не включать status: deprecated,

по возможности предпочитать status: accepted, foundational.

6. Режимы использования RAG
6.1. Режим “Учитель для автора”
Автор задаёт вопросы:

“почему extended-mind говорит от первого лица?”

“что мы решили про story-layer?”

“как правильно выделять story-node из чата?”

“что такое author-line в терминах системы?”

RAG:

поднимает ADR,

поднимает определения,

поднимает паттерны,

extended-mind на основе этого формирует ответ.

6.2. Режим “Компас для V&P и других проектов”
Extended-mind отвечает на:

“где граница между V&P и extended-mind?”

“что должен уметь thin-tank?”

“какая роль персоны Ancy в онтологии?”

RAG:

использует:

project-frame V&P,

character-map,

concept maps.

6.3. Режим “Архитектор”
Extended-mind, проектируя новые элементы (проекты, паттерны, ADR),
будет использовать RAG для:

поиска похожих решений,

проверки консистентности:

не противоречит ли новое решение уже принятому,

не существует ли уже похожий паттерн.

7. Ограничения v0.1 (осознанные)
Нет графа:

связи пока живут в текстах и тегах,

нет отдельной графовой БД.

Нет сложной маршрутизации:

только один индекс,

фильтрация и приоритизация через простые правила.

Нет автоматического ingestion из внешних репо (V&P и др.):

на этапе v0.1 работаем только с содержимым extended-mind,

интеграция с vovaipetrova-core и другими репо — позже.

8. Дальнейшие шаги (v0.2+)
Добавить story-layer-индекс

отдельный индекс для story-node и machine-log-конденсатов,

только для внутренней работы, без статуса “истина”.

Добавить проектные индексы

отдельные подиндексы для V&P, evoquant, word-machine,

с настройкой разных приоритетов.

Перейти к Graph/RAG-гибридам

извлечение сущностей и отношений,

построение графа поверх уже отdebug’анного текста.

Ввести eval-процессы

как extended-mind проверяет, что RAG отвечает “по делу”,

простейшие sanity-checks.

9. Статус документа
Это черновой, но сознательно упрощённый план RAG-архитектуры v0.1.
Его задача — задать форму, не блокируя движение вперёд.

По мере реализации:

уточняются коллекции,

настраивается чанкование,

добавляются ADR по конкретным решениям (тип БД, библиотека, пайплайны).
