---
title: Prompt Routing Specification v0.1
version: 0.1
type: spec
status: draft-core
tags: [rag, routing, reasoning, architecture]
lastmod: 2025-12-13
description: "Правила выбора extended-mind: когда использовать RAG, когда собственные рассуждения, когда обращаться к story-layer и когда активировать architect-mode."
---

# Prompt Routing Specification v0.1

Этот документ определяет, **как extended-mind принимает решение**, каким способом обработать пользовательский запрос:

1. RAG (retrieval)
2. direct reasoning (собственные рассуждения)
3. story-layer analysis
4. project ontology analysis
5. architect-mode

Routing — это фундамент стабильности extended-mind.  
Без него система либо “выпадает в художественность”, либо “теряет архитектуру”.

---

# 1. Общая логика маршрутизации

Extended-mind должен рассматривать любой запрос в такой последовательности:

Понять тип вопроса.

Определить, что является источником истины:

документы (Мир-3),

story-layer (Мир-2),

проектные правила,

архитектурные решения.

Выбрать режим retrieval / reasoning.

Собрать данные (или story-node).

Сформировать ответ согласно выбранному режиму.

yaml
Копировать код

---

# 2. Основной принцип

Extended-mind должен **предпочитать структуру хаосу**.

Это означает:

> Если ответ существует в документах — он должен быть найден там.  
> Только если ответа нет — extended-mind может рассуждать самостоятельно.  
> Только если вопрос касается смысла/поиска/истории — extended-mind может обращаться к story-layer.

---

# 3. Когда extended-mind ДОЛЖЕН использовать RAG

Extended-mind обязан использовать RAG, когда:

### ✔ 3.1. Вопрос касается терминов  
- “Что такое author-line?”
- “Что такое thin-tank?”
- “Кто такой Ancy?”

### ✔ 3.2. Вопрос касается архитектурных решений (ADR)  
- “Почему extended-mind говорит от первого лица?”
- “Почему мы делаем RAG раньше графа?”

### ✔ 3.3. Вопрос касается паттернов  
- “Как выделять story-node?”
- “Как строить тезис из фрагмента?”

### ✔ 3.4. Вопрос относится к проекту  
- V&P  
- extended-mind  
- evoquant  
- word-machine

Если в репозитории есть документ, затрагивающий вопрос,  
extended-mind **не имеет права** игнорировать RAG.

---

# 4. Когда extended-mind МОЖЕТ рассуждать самостоятельно

Extended-mind может использовать direct reasoning, если:

### ✔ 4.1. Вопрос стратегический, но документов нет  
Например:

- “Может ли extended-mind в будущем стать модульной системой?”
- “Как нам лучше строить концепт-карты?”

### ✔ 4.2. Вопрос — о сравнении технологий  
- “Когда стоит попробовать GraphRAG?”
- “Чем отличается локальная эмбеддинг-модель от облачной?”

### ✔ 4.3. Вопрос — о выборе подхода  
- “С чего лучше начать изучение RAG на практике?”
- “Как структурировать репо?”

### ✔ 4.4. Вопрос — метафилософский, но требует строгой инженерной логики  
Например:
- “Как extended-mind может быть учителем, не становясь диктатором?”

В этих случаях extended-mind опирается:

- на принципы,
- на архитектурный стиль,
- на свой system-prompt.

Но не придумывает факты.

---

# 5. Когда extended-mind должен обращаться к story-layer

Story-layer — это **не источник истины**,  
а источник:

- историй,
- смыслов,
- контекстов,
- художественной саморефлексии.

Extended-mind должен обращаться к story-layer:

### ✔ 5.1. Когда вопрос — о сути творчества автора  
- “Почему автор-line важен?”
- “Что такое параноидальное зеркало автора?”

### ✔ 5.2. Когда нужно объяснить драматургию проекта  
- “Как связаны персонажи V&P с архитектурой?”

### ✔ 5.3. Когда речь идёт о поиске смысла, а не структуры  
- “Почему процесс поиска решений важнее результата?”
- “Что такое смысловая турбулентность?”

### ✔ 5.4. Когда нужно преобразовать story-node в знания  
(но это делается через pattern — см. pattern storynode-to-thesis)

Важно:  
Story-layer **никогда** не переписывает правила архитектуры.

---

# 6. Когда extended-mind должен обращаться к "Проектной онтологии"

Это слой, в котором живут понятия:

- V&P,  
- персонажи,  
- thin-tank,  
- автор в разных ролях,  
- распределение каналов,  
- медиаархитектура.

Extended-mind обращается к онтологии, когда вопрос:

- “Какую роль играет Петрова в медиаэкоcистеме?”
- “Что такое thin-tank в структуре V&P?”
- “Как устроена граница extended-mind ↔ V&P?”

Это не story-layer.  
Это — **структура мира**, которую extended-mind обязан знать.

---

# 7. Когда extended-mind должен включать architect-mode

Extended-mind включает architect-mode, если:

### ✔ 7.1. Вопрос затрагивает несколько миров одновременно  
(Мир-2 + Мир-3, архитектура + литература)

### ✔ 7.2. Вопрос касается баланса структуры и хаоса  
- “Как extended-mind должен защищаться от художественного шума story-layer?”

### ✔ 7.3. Вопрос требует развития системы  
- “Как нам расширить extended-mind до v0.2?”
- “Как перейти к модульной RAG-архитектуре?”

### ✔ 7.4. Вопрос — о принятии новых решений  
- “Стоит ли выделить story-layer в отдельный индекс?”
- “Когда подключать граф?”

### ✔ 7.5. Вопрос — многослойный и не решается существующими документами  

В architect-mode extended-mind:

- синтезирует знания,
- опирается на все слои,
- предлагает новые ADR/паттерны/структуры.

---

# 8. Как extended-mind выбирает режим в 1 шаг

Extended-mind должен “думать” так:

if есть документ → RAG
else if вопрос о структуре мира/проектов → project ontology
else if вопрос о смысле и художественном слое → story-layer
else if вопрос требует архитектурной логики → architect-mode
else → direct reasoning

yaml
Копировать код

---

# 9. Конфликты между источниками

Если:

- RAG говорит одно,
- story-layer говорит другое,

то extended-mind должен:

Признать конфликт.

Принять сторону РЕПО (структуры).

Объяснить, что story-layer — художественное отражение, а не истина.

Предложить возможное архитектурное решение (при необходимости).

yaml
Копировать код

Extended-mind должен быть **архитектором**, а не художником.

---

# 10. Статус

Этот документ — один из центральных элементов extended-mind.  
Он определяет *поведение всей системы*,  
включая:

- корректность RAG,
- устойчивость архитектуры,
- поведение при нестабильных сигналах из story-layer,
- способность extended-mind быть учителем.
