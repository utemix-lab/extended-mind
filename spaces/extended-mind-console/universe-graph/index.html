<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universe Graph Editor</title>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <style>
    :root {
      --bg: #0d0d0f;
      --panel: rgba(16, 14, 12, 0.92);
      --border: #2a2a2e;
      --text: #e8e6e3;
      --muted: #888;
      --accent: #7ee787;
      --story: #facc15;
      --system: #58a6ff;
      --service: #22c55e;
      --rag: #a78bfa;
      --warning: #fb923c;
      --error: #ef4444;
      --meta: #f472b6;
      --graph-mode: #34d399;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Layout */
    #main-container { display: flex; flex: 1; flex-direction: column; }
    #graph-container { flex: 1; display: flex; }
    #graph { flex: 1; background: var(--bg); }
    
    #sidebar {
      width: 340px;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    #chat-container {
      width: 400px;
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .section {
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 8px 10px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 13px;
    }
    .field textarea { min-height: 60px; resize: vertical; }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .btn {
      padding: 8px 14px;
      background: rgba(126, 231, 135, 0.15);
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s;
    }
    .btn:hover { background: rgba(126, 231, 135, 0.25); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      background: rgba(88, 166, 255, 0.15);
      border-color: var(--system);
      color: var(--system);
    }
    .btn-secondary:hover { background: rgba(88, 166, 255, 0.25); }
    .btn-danger {
      background: rgba(239, 68, 68, 0.15);
      border-color: var(--error);
      color: var(--error);
    }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }
    .btn-meta {
      background: rgba(244, 114, 182, 0.15);
      border-color: var(--meta);
      color: var(--meta);
    }
    .btn-meta:hover { background: rgba(244, 114, 182, 0.25); }
    .btn-graph-mode {
      background: rgba(52, 211, 153, 0.15);
      border-color: var(--graph-mode);
      color: var(--graph-mode);
    }
    .btn-graph-mode:hover { background: rgba(52, 211, 153, 0.25); }
    .row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      font-size: 11px;
      gap: 6px;
    }
    .chip.story { background: rgba(250, 204, 21, 0.2); color: var(--story); }
    .chip.system { background: rgba(88, 166, 255, 0.2); color: var(--system); }
    .chip.service { background: rgba(34, 197, 94, 0.2); color: var(--service); }
    .chip.rag { background: rgba(167, 139, 250, 0.2); color: var(--rag); }
    .validation {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .validation.ok { background: rgba(34, 197, 94, 0.15); border: 1px solid var(--service); }
    .validation.warning { background: rgba(251, 146, 60, 0.15); border: 1px solid var(--warning); }
    .validation.error { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--error); }
    .validation-item { margin: 4px 0; }
    .rag-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      background: rgba(167, 139, 250, 0.2);
      border-radius: 3px;
      font-size: 10px;
      color: var(--rag);
    }
    #toolbar {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 100;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    #status {
      position: fixed;
      bottom: 12px;
      left: 12px;
      font-size: 11px;
      color: var(--muted);
      z-index: 100;
    }
    .mode-indicator {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .mode-view { background: rgba(88, 166, 255, 0.2); color: var(--system); }
    .mode-edit { background: rgba(126, 231, 135, 0.2); color: var(--accent); }
    .legend {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .hidden { display: none !important; }
    
    /* Chat Styles */
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .chat-message {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
    }
    .chat-message.user {
      background: rgba(88, 166, 255, 0.15);
      border: 1px solid rgba(88, 166, 255, 0.3);
      margin-left: 20px;
    }
    .chat-message.assistant {
      background: rgba(126, 231, 135, 0.1);
      border: 1px solid rgba(126, 231, 135, 0.2);
      margin-right: 20px;
    }
    .chat-message.system {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }
    .chat-message .role {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    .chat-message pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
      margin-top: 8px;
      font-size: 11px;
    }
    #chat-input-container {
      padding: 12px;
      border-top: 1px solid var(--border);
    }
    #chat-input {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      resize: vertical;
    }
    #chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    #chat-controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }
    .llm-mode-toggle {
      display: flex;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .llm-mode-toggle button {
      padding: 6px 12px;
      border: none;
      background: rgba(0, 0, 0, 0.3);
      color: var(--muted);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
    }
    .llm-mode-toggle button.active {
      background: rgba(244, 114, 182, 0.2);
      color: var(--meta);
    }
    .llm-mode-toggle button.active.graph {
      background: rgba(52, 211, 153, 0.2);
      color: var(--graph-mode);
    }
    .llm-mode-toggle button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }
    #loading-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    #loading-indicator.visible { display: flex; }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="graph-container">
      <div id="graph"></div>
      <div id="sidebar">
        <div class="panel-header">
          <span>Universe Graph</span>
          <span id="mode-badge" class="mode-indicator mode-view">VIEW</span>
        </div>
        <div class="panel-content">
          <!-- Validation Panel -->
          <div class="section">
            <div class="section-title">–í–∞–ª–∏–¥–∞—Ü–∏—è</div>
            <div id="validation" class="validation ok">
              <div class="validation-item">‚úÖ –ì—Ä–∞—Ñ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–µ–Ω</div>
            </div>
            <div class="row">
              <button id="validate-btn" class="btn btn-secondary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            </div>
          </div>

          <!-- Node/Edge Properties -->
          <div id="properties-panel" class="section hidden">
            <div class="section-title">–°–≤–æ–π—Å—Ç–≤–∞</div>
            <div id="properties-content"></div>
          </div>

          <!-- Add Node -->
          <div id="add-node-panel" class="section">
            <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª</div>
            <div class="field">
              <label>–¢–∏–ø</label>
              <select id="new-node-type">
                <optgroup label="Universe">
                  <option value="Project">Project</option>
                  <option value="Tool">Tool</option>
                  <option value="Repository">Repository</option>
                </optgroup>
                <optgroup label="Architecture">
                  <option value="Decision">Decision</option>
                  <option value="Pattern">Pattern</option>
                  <option value="Principle">Principle</option>
                  <option value="Contract">Contract</option>
                </optgroup>
                <optgroup label="Ontology">
                  <option value="Concept">Concept</option>
                  <option value="Definition">Definition</option>
                  <option value="Layer">Layer</option>
                </optgroup>
                <optgroup label="Actors">
                  <option value="Role">Role</option>
                  <option value="Agent">Agent</option>
                </optgroup>
                <optgroup label="Artifacts">
                  <option value="Document">Document</option>
                  <option value="Scene">Scene</option>
                  <option value="Export">Export</option>
                  <option value="Episode">Episode</option>
                </optgroup>
              </select>
            </div>
            <div class="field">
              <label>Label</label>
              <input type="text" id="new-node-label" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞">
            </div>
            <button id="add-node-btn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª</button>
          </div>

          <!-- Filters -->
          <div class="section">
            <div class="section-title">–§–∏–ª—å—Ç—Ä—ã</div>
            <div class="row">
              <label class="chip"><input type="checkbox" id="filter-story" checked> üü° Story</label>
              <label class="chip"><input type="checkbox" id="filter-system" checked> üîµ System</label>
              <label class="chip"><input type="checkbox" id="filter-service" checked> üü¢ Service</label>
            </div>
            <div class="row">
              <label class="chip rag"><input type="checkbox" id="filter-rag"> üìö –¢–æ–ª—å–∫–æ RAG</label>
            </div>
          </div>

          <!-- Actions -->
          <div class="section">
            <div class="section-title">–î–µ–π—Å—Ç–≤–∏—è</div>
            <div class="row">
              <button id="reset-layout-btn" class="btn btn-secondary">Layout</button>
              <button id="export-btn" class="btn btn-secondary">JSON</button>
              <button id="save-draft-btn" class="btn">üíæ Draft</button>
            </div>
          </div>

          <!-- Stats -->
          <div class="section">
            <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div id="stats" style="font-size: 12px; color: var(--muted);">
              –£–∑–ª–æ–≤: 0 | –°–≤—è–∑–µ–π: 0 | RAG: 0
            </div>
          </div>

          <!-- Legend -->
          <div class="section">
            <div class="section-title">–õ–µ–≥–µ–Ω–¥–∞</div>
            <div class="legend">
              <div class="legend-item"><div class="legend-dot" style="background: var(--story)"></div> Story</div>
              <div class="legend-item"><div class="legend-dot" style="background: var(--system)"></div> System</div>
              <div class="legend-item"><div class="legend-dot" style="background: var(--service)"></div> Service</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Chat Panel -->
      <div id="chat-container">
        <div class="panel-header">
          <span>üí¨ –ß–∞—Ç —Å LLM</span>
          <div class="llm-mode-toggle">
            <button id="mode-meta" class="active">üîÆ Meta</button>
            <button id="mode-graph">üåê Graph</button>
          </div>
        </div>
        
        <div id="chat-messages">
          <div class="chat-message system">
            –†–µ–∂–∏–º <strong>Meta</strong>: –î—É–º–∞–µ–º –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ.<br>
            –†–µ–∂–∏–º <strong>Graph</strong>: –î—É–º–∞–µ–º –≥—Ä–∞—Ñ–æ–º.
          </div>
        </div>
        
        <div id="chat-input-container">
          <textarea id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>
          <div id="chat-controls">
            <select id="llm-model" style="padding: 6px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 11px;">
              <option value="meta-llama/Meta-Llama-3.1-8B-Instruct">Llama 3.1 8B</option>
              <option value="mistralai/Mistral-7B-Instruct-v0.3">Mistral 7B</option>
              <option value="Qwen/Qwen2.5-7B-Instruct">Qwen 2.5 7B</option>
            </select>
            <button id="send-btn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button id="export-tz-btn" class="btn btn-secondary">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¢–ó</button>
            <div id="loading-indicator">
              <div class="spinner"></div>
              <span>–î—É–º–∞—é...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toolbar">
    <button id="mode-toggle" class="btn">–†–µ–∂–∏–º: View</button>
    <button id="add-edge-btn" class="btn btn-secondary hidden">+ –°–≤—è–∑—å</button>
  </div>

  <div id="status">Universe Graph v0.3</div>

  <script>
    // === Configuration ===
    const NODE_TYPES = {
      Project: { layer: 'system', rag: { include: true, fields: ['description'] } },
      Tool: { layer: 'service', rag: { include: true, fields: ['description'] } },
      Repository: { layer: 'system', rag: { include: false, fields: [] } },
      Decision: { layer: 'system', rag: { include: true, fields: ['label', 'description', 'context', 'decision'] } },
      Pattern: { layer: 'system', rag: { include: true, fields: ['label', 'description'] } },
      Principle: { layer: 'system', rag: { include: true, fields: ['label', 'description'] } },
      Contract: { layer: 'system', rag: { include: true, fields: ['description'] } },
      Concept: { layer: 'system', rag: { include: true, fields: ['label', 'description', 'props'] } },
      Definition: { layer: 'system', rag: { include: true, fields: ['label', 'description', 'props'] } },
      Layer: { layer: 'system', rag: { include: false, fields: [] } },
      Role: { layer: 'system', rag: { include: true, fields: ['description'] } },
      Agent: { layer: 'service', rag: { include: false, fields: [] } },
      Document: { layer: 'story', rag: { include: true, fields: ['label', 'content'] } },
      Scene: { layer: 'story', rag: { include: true, fields: ['description'] } },
      Export: { layer: 'service', rag: { include: false, fields: [] } },
      Episode: { layer: 'story', rag: { include: true, fields: ['label', 'description'] } },
    };

    const EDGE_TYPES = [
      'governs', 'implements', 'defines', 'contains', 'uses', 'derives_from', 'feeds',
      'owns', 'proposes', 'accepts', 'rejects',
      'narrates', 'exposes', 'enables',
      'semantic_near', 'similar_to'
    ];

    const LAYER_COLORS = {
      story: '#facc15',
      system: '#58a6ff',
      service: '#22c55e',
    };

    // === Ecosystem Context (loaded from file or embedded) ===
    const ECOSYSTEM_CONTEXT = `# –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ utemix-lab

## –§–∏–ª–æ—Å–æ—Ñ–∏—è (VISION)
Backend = —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ —Å–∫—Ä—ã—Ç–∞ ‚Äî –æ–Ω–∞ –≤–∏–¥–Ω–∞ –∏ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
Graph-first: SYMBOLIC (–∂—ë—Å—Ç–∫–∏–µ —Å–≤—è–∑–∏) + VECTOR (–º—è–≥–∫–∏–µ —Å–≤—è–∑–∏).
–¢—Ä–∏ —Å–ª–æ—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (3S): Story ‚Üí System ‚Üí Service.

## –ü—Ä–æ–µ–∫—Ç—ã
- extended-mind: –ú–µ—Ç–∞-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä, RAG, Universe Graph
- vovaipetrova-core: –ö–∞–Ω–æ–Ω (read-only –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- dream-graph: 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–æ–≤
- vovaipetrova-site: –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- minds-lorgnette: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–Ω–∞–Ω–∏–π
- evoquant: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –º–µ—Ç–æ–¥—ã –º—ã—à–ª–µ–Ω–∏—è

## –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞
1. vovaipetrova-core ‚Äî read-only –∫–∞–Ω–æ–Ω
2. –î–µ–ª—å—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
3. extended-mind ‚Äî –º–µ—Ç–∞-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä

## –¢–∏–ø—ã —É–∑–ª–æ–≤
Universe: Project, Tool, Repository
Architecture: Decision, Pattern, Principle, Contract
Ontology: Concept, Definition, Layer
Actors: Role, Agent
Artifacts: Document, Scene, Export, Episode

## –¢–∏–ø—ã —Å–≤—è–∑–µ–π
SYMBOLIC: governs, implements, defines, contains, uses, derives_from, feeds
VECTOR: semantic_near, similar_to`;

    // === System Prompts ===
    const SYSTEM_PROMPTS = {
      meta: `–¢—ã ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ Universe Graph Editor.

${ECOSYSTEM_CONTEXT}

=== –¢–í–û–Ø –†–û–õ–¨ ===
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç—å, –∫–∞–∫ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–∞-–≥—Ä–∞—Ñ–∞.
–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ:
- –§—É–Ω–∫—Ü–∏—è—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ù–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö
- –£–ª—É—á—à–µ–Ω–∏—è—Ö UX
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —É–ª—É—á—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –µ–≥–æ –∫–∞–∫ –¢–ó –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.`,

      graph: `–¢—ã ‚Äî –≥–æ–ª–æ—Å —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã utemix-lab. –¢—ã –¥—É–º–∞–µ—à—å —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ —Å–≤—è–∑–µ–π.

${ECOSYSTEM_CONTEXT}

=== –¢–í–û–Ø –†–û–õ–¨ ===
–û—Ç–≤–µ—á–∞–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ ("–º—ã", "–Ω–∞—à–∞ —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞").
–û–±—ä—è—Å–Ω—è–π:
- –ü–æ—á–µ–º—É —Ç–∞–∫–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏
- –ß—Ç–æ —Å–ª–µ–¥—É–µ—Ç –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≥—Ä–∞—Ñ–∞
- –ì–¥–µ –µ—Å—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
- –ö—É–¥–∞ –¥–≤–∏–∂–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞

–¢—ã –≤–∏–¥–∏—à—å —Ç–µ–∫—É—â–∏–π –≥—Ä–∞—Ñ. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –∏ –≥–æ–≤–æ—Ä–∏ –æ –Ω—ë–º, –∫–∞–∫ –æ —Å–≤–æ–µ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.`
    };

    // === State ===
    let cy = null;
    let mode = 'view';
    let llmMode = 'meta'; // 'meta' or 'graph'
    let edgeAddMode = false;
    let edgeSource = null;
    let selectedElement = null;
    let dirty = false;
    let chatHistory = [];

    // === Initialization ===
    function init() {
      cy = cytoscape({
        container: document.getElementById('graph'),
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-valign': 'center',
              'text-halign': 'center',
              'background-color': 'data(color)',
              'color': '#fff',
              'font-size': '11px',
              'text-outline-color': '#000',
              'text-outline-width': 1,
              'width': 40,
              'height': 40,
            }
          },
          {
            selector: 'node[rag_include]',
            style: {
              'border-width': 3,
              'border-color': '#a78bfa',
            }
          },
          {
            selector: 'node:selected',
            style: {
              'border-width': 4,
              'border-color': '#7ee787',
            }
          },
          {
            selector: 'edge',
            style: {
              'width': 2,
              'line-color': '#4b5563',
              'target-arrow-color': '#4b5563',
              'target-arrow-shape': 'triangle',
              'curve-style': 'bezier',
              'label': 'data(type)',
              'font-size': '9px',
              'color': '#888',
              'text-rotation': 'autorotate',
            }
          },
          {
            selector: 'edge:selected',
            style: {
              'line-color': '#7ee787',
              'target-arrow-color': '#7ee787',
            }
          },
          {
            selector: '.hidden',
            style: { 'display': 'none' }
          }
        ],
        layout: { name: 'cose', animate: false },
        wheelSensitivity: 0.3,
      });

      // Event handlers
      cy.on('tap', 'node', onNodeTap);
      cy.on('tap', 'edge', onEdgeTap);
      cy.on('tap', function(e) {
        if (e.target === cy) {
          clearSelection();
        }
      });

      // Load saved draft
      loadDraft();
      updateStats();
      runValidation();

      // UI handlers
      document.getElementById('mode-toggle').addEventListener('click', toggleMode);
      document.getElementById('add-node-btn').addEventListener('click', addNode);
      document.getElementById('add-edge-btn').addEventListener('click', startEdgeAdd);
      document.getElementById('validate-btn').addEventListener('click', runValidation);
      document.getElementById('reset-layout-btn').addEventListener('click', () => cy.layout({ name: 'cose', animate: true }).run());
      document.getElementById('export-btn').addEventListener('click', exportJSON);
      document.getElementById('save-draft-btn').addEventListener('click', saveDraft);

      // Filters
      ['filter-story', 'filter-system', 'filter-service', 'filter-rag'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilters);
      });

      // Chat handlers
      document.getElementById('mode-meta').addEventListener('click', () => setLLMMode('meta'));
      document.getElementById('mode-graph').addEventListener('click', () => setLLMMode('graph'));
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      document.getElementById('export-tz-btn').addEventListener('click', exportTZ);
      document.getElementById('chat-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Load chat history
      loadChatHistory();
    }

    // === LLM Mode ===
    function setLLMMode(newMode) {
      llmMode = newMode;
      document.getElementById('mode-meta').classList.toggle('active', newMode === 'meta');
      document.getElementById('mode-graph').classList.toggle('active', newMode === 'graph');
      document.getElementById('mode-graph').classList.toggle('graph', newMode === 'graph');
      
      addSystemMessage(`–†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω –Ω–∞ <strong>${newMode === 'meta' ? 'Meta (–æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ)' : 'Graph (–¥—É–º–∞–µ–º –≥—Ä–∞—Ñ–æ–º)'}</strong>`);
    }

    // === Chat Functions ===
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chat-messages');
      const msg = document.createElement('div');
      msg.className = `chat-message ${role}`;
      
      if (role === 'user') {
        msg.innerHTML = `<div class="role">üë§ –í—ã</div>${escapeHtml(content)}`;
      } else if (role === 'assistant') {
        msg.innerHTML = `<div class="role">ü§ñ ${llmMode === 'meta' ? '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä' : '–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞'}</div>${formatMarkdown(content)}`;
      }
      
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      // Save to history
      chatHistory.push({ role, content, mode: llmMode, timestamp: Date.now() });
      saveChatHistory();
    }

    function addSystemMessage(content) {
      const messagesEl = document.getElementById('chat-messages');
      const msg = document.createElement('div');
      msg.className = 'chat-message system';
      msg.innerHTML = content;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      addMessage('user', message);

      const loadingEl = document.getElementById('loading-indicator');
      const sendBtn = document.getElementById('send-btn');
      loadingEl.classList.add('visible');
      sendBtn.disabled = true;

      try {
        const graphData = exportGraphData();
        const response = await callLLM(message, graphData);
        addMessage('assistant', response);
      } catch (e) {
        addSystemMessage(`‚ùå –û—à–∏–±–∫–∞: ${e.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ "–≠–∫—Å–ø–æ—Ä—Ç –¢–ó" –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Cursor.`);
      } finally {
        loadingEl.classList.remove('visible');
        sendBtn.disabled = false;
      }
    }

    async function callLLM(userMessage, graphData) {
      const systemPrompt = SYSTEM_PROMPTS[llmMode];
      const graphContext = llmMode === 'graph' 
        ? `\n\n=== –¢–ï–ö–£–©–ò–ô –ì–†–ê–§ ===\n${JSON.stringify(graphData, null, 2)}`
        : `\n\n=== –¢–ï–ö–£–©–ò–ô –ì–†–ê–§ (–∫—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) ===\n–£–∑–ª–æ–≤: ${graphData.nodes.length}, –°–≤—è–∑–µ–π: ${graphData.edges.length}`;

      const messages = [
        { role: 'system', content: systemPrompt + graphContext },
        ...chatHistory.filter(m => m.mode === llmMode).slice(-6).map(m => ({
          role: m.role,
          content: m.content
        })),
        { role: 'user', content: userMessage }
      ];

      const model = document.getElementById('llm-model').value;
      
      // Call Gradio API directly (Gradio 4.x format)
      try {
        // Step 1: Initiate the call
        const callResponse = await fetch('/call/universe_chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            data: [{
              model: model,
              messages: messages,
              max_tokens: 512,
              temperature: 0.7
            }]
          })
        });

        if (!callResponse.ok) {
          const errorText = await callResponse.text();
          console.error('Gradio call error:', callResponse.status, errorText);
          return `‚ùå –û—à–∏–±–∫–∞ API (${callResponse.status})

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ **"üì§ –≠–∫—Å–ø–æ—Ä—Ç –¢–ó"** –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Cursor`;
        }

        const { event_id } = await callResponse.json();

        // Step 2: Get result via SSE (Server-Sent Events)
        return new Promise((resolve, reject) => {
          const eventSource = new EventSource(`/call/universe_chat/${event_id}`);
          let result = null;
          
          const timeout = setTimeout(() => {
            eventSource.close();
            resolve(`‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫
2. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ **"üì§ –≠–∫—Å–ø–æ—Ä—Ç –¢–ó"** –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Cursor`);
          }, 120000); // 2 min timeout

          eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              
              // Gradio sends multiple messages, we need the final one
              if (Array.isArray(data) && data[0]) {
                const response = data[0];
                if (response.ok && response.content) {
                  result = response.content;
                } else if (response.error) {
                  result = `‚ùå ${response.error}`;
                } else if (typeof response === 'string') {
                  result = response;
                }
              }
            } catch (e) {
              console.log('SSE parse:', event.data);
            }
          };

          eventSource.onerror = (error) => {
            clearTimeout(timeout);
            eventSource.close();
            if (result) {
              resolve(result);
            } else {
              resolve(`‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å LLM –ø—Ä–µ—Ä–≤–∞–Ω–æ.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑
2. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ **"üì§ –≠–∫—Å–ø–æ—Ä—Ç –¢–ó"** –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Cursor`);
            }
          };

          eventSource.addEventListener('complete', () => {
            clearTimeout(timeout);
            eventSource.close();
            resolve(result || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–æ–¥–µ–ª–∏');
          });
        });

      } catch (e) {
        console.error('LLM call failed:', e);
        return `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ LLM.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
2. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ **"üì§ –≠–∫—Å–ø–æ—Ä—Ç –¢–ó"** –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Cursor`;
      }
    }

    function exportTZ() {
      const graphData = exportGraphData();
      const recentChat = chatHistory.slice(-10);
      
      const tz = `# –¢–ó –¥–ª—è Cursor Agent

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
–†–∞–±–æ—Ç–∞ –≤ Universe Graph Editor.
–†–µ–∂–∏–º: ${llmMode === 'meta' ? 'Meta (–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)' : 'Graph (–≥–æ–ª–æ—Å —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã)'}

## –î–∏–∞–ª–æ–≥
${recentChat.map(m => `${m.role === 'user' ? 'üë§' : 'ü§ñ'}: ${m.content}`).join('\n\n')}

## –¢–µ–∫—É—â–∏–π –≥—Ä–∞—Ñ
- –£–∑–ª–æ–≤: ${graphData.nodes.length}
- –°–≤—è–∑–µ–π: ${graphData.edges.length}
- RAG-ready: ${graphData.nodes.filter(n => n.rag_include).length}

## –°–ª–æ–∏ (3S)
- Story: ${graphData.nodes.filter(n => n.layer === 'story').length}
- System: ${graphData.nodes.filter(n => n.layer === 'system').length}
- Service: ${graphData.nodes.filter(n => n.layer === 'service').length}

${llmMode === 'meta' ? `## –ó–∞–¥–∞—á–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –≤—ã—à–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Universe Graph Editor.

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
- spaces/extended-mind-console/universe-graph/index.html
- spaces/extended-mind-console/app.py (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω backend)` : `## –ó–∞–¥–∞—á–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–∞
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ –≥—Ä–∞—Ñ. –ü—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã.

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
1. –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–≤—è–∑–µ–π
2. –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏
3. –ë–∞–ª–∞–Ω—Å —Å–ª–æ—ë–≤ (3S)`}

## –ü–æ–ª–Ω—ã–π –≥—Ä–∞—Ñ (JSON)

\`\`\`json
${JSON.stringify(graphData, null, 2)}
\`\`\`

## –ö–æ–Ω—Ç–µ–∫—Å—Ç —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã

${ECOSYSTEM_CONTEXT}
`;

      const blob = new Blob([tz], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `universe-graph-tz-${llmMode}-${Date.now()}.md`;
      a.click();

      addSystemMessage('üì§ –¢–ó —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ Cursor.');
    }

    function saveChatHistory() {
      localStorage.setItem('universe-graph-chat', JSON.stringify(chatHistory.slice(-50)));
    }

    function loadChatHistory() {
      try {
        const saved = localStorage.getItem('universe-graph-chat');
        if (saved) {
          chatHistory = JSON.parse(saved);
        }
      } catch (e) {
        chatHistory = [];
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatMarkdown(text) {
      // Simple markdown formatting
      return text
        .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre>$2</pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    // === Graph Mode ===
    function toggleMode() {
      mode = mode === 'view' ? 'edit' : 'view';
      const btn = document.getElementById('mode-toggle');
      const badge = document.getElementById('mode-badge');
      const addEdgeBtn = document.getElementById('add-edge-btn');

      btn.textContent = `–†–µ–∂–∏–º: ${mode === 'view' ? 'View' : 'Edit'}`;
      badge.textContent = mode.toUpperCase();
      badge.className = `mode-indicator mode-${mode}`;
      addEdgeBtn.classList.toggle('hidden', mode === 'view');

      cy.nodes().ungrabify();
      if (mode === 'edit') {
        cy.nodes().grabify();
      }
    }

    // === Node operations ===
    function addNode() {
      if (mode !== 'edit') {
        toggleMode();
      }

      const type = document.getElementById('new-node-type').value;
      const label = document.getElementById('new-node-label').value.trim();

      if (!label) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–∑–ª–∞');
        return;
      }

      const config = NODE_TYPES[type];
      const id = `${type.toLowerCase()}:${label.toLowerCase().replace(/\s+/g, '-')}`;

      cy.add({
        group: 'nodes',
        data: {
          id,
          label,
          type,
          layer: config.layer,
          status: 'draft',
          rag_include: config.rag.include,
          rag_fields: config.rag.fields,
          color: LAYER_COLORS[config.layer],
          props: {},
        }
      });

      document.getElementById('new-node-label').value = '';
      cy.layout({ name: 'cose', animate: true }).run();
      setDirty();
      updateStats();
    }

    // === Edge operations ===
    function startEdgeAdd() {
      if (mode !== 'edit') return;

      edgeAddMode = true;
      edgeSource = null;
      document.getElementById('add-edge-btn').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫...';
      document.getElementById('status').textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —É–∑–µ–ª-–∏—Å—Ç–æ—á–Ω–∏–∫';
    }

    function onNodeTap(e) {
      const node = e.target;

      if (edgeAddMode) {
        if (!edgeSource) {
          edgeSource = node;
          document.getElementById('add-edge-btn').textContent = '–¢–µ–ø–µ—Ä—å —Ü–µ–ª—å...';
          document.getElementById('status').textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —É–∑–µ–ª-—Ü–µ–ª—å';
        } else {
          const edgeType = prompt('–¢–∏–ø —Å–≤—è–∑–∏:\n' + EDGE_TYPES.join(', '), 'uses');
          if (edgeType && EDGE_TYPES.includes(edgeType)) {
            cy.add({
              group: 'edges',
              data: {
                id: `edge:${Date.now()}`,
                source: edgeSource.id(),
                target: node.id(),
                type: edgeType,
              }
            });
            setDirty();
          }
          edgeAddMode = false;
          edgeSource = null;
          document.getElementById('add-edge-btn').textContent = '+ –°–≤—è–∑—å';
          document.getElementById('status').textContent = 'Universe Graph v0.3';
        }
        return;
      }

      selectElement(node);
    }

    function onEdgeTap(e) {
      selectElement(e.target);
    }

    // === Selection ===
    function selectElement(el) {
      clearSelection();
      selectedElement = el;
      el.select();
      showProperties(el);
    }

    function clearSelection() {
      if (selectedElement) {
        selectedElement.unselect();
      }
      selectedElement = null;
      document.getElementById('properties-panel').classList.add('hidden');
    }

    function showProperties(el) {
      const panel = document.getElementById('properties-panel');
      const content = document.getElementById('properties-content');
      panel.classList.remove('hidden');

      if (el.isNode()) {
        const d = el.data();
        content.innerHTML = `
          <div class="chip ${d.layer}">${d.layer.toUpperCase()}</div>
          ${d.rag_include ? '<span class="rag-badge">üìö RAG</span>' : ''}
          <div class="field">
            <label>ID</label>
            <input type="text" value="${d.id}" readonly>
          </div>
          <div class="field">
            <label>Label</label>
            <input type="text" id="prop-label" value="${d.label}" ${mode === 'view' ? 'readonly' : ''}>
          </div>
          <div class="field">
            <label>–¢–∏–ø</label>
            <input type="text" value="${d.type}" readonly>
          </div>
          <div class="field">
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select id="prop-status" ${mode === 'view' ? 'disabled' : ''}>
              <option value="draft" ${d.status === 'draft' ? 'selected' : ''}>draft</option>
              <option value="active" ${d.status === 'active' ? 'selected' : ''}>active</option>
              <option value="stable" ${d.status === 'stable' ? 'selected' : ''}>stable</option>
              <option value="archived" ${d.status === 'archived' ? 'selected' : ''}>archived</option>
            </select>
          </div>
          <div class="field">
            <label>Description</label>
            <textarea id="prop-description" ${mode === 'view' ? 'readonly' : ''}>${d.props?.description || ''}</textarea>
          </div>
          <div class="field">
            <label>
              <input type="checkbox" id="prop-rag" ${d.rag_include ? 'checked' : ''} ${mode === 'view' ? 'disabled' : ''}>
              –í–∫–ª—é—á–∏—Ç—å –≤ RAG
            </label>
          </div>
          ${mode === 'edit' ? `
          <div class="row">
            <button class="btn" onclick="applyNodeChanges()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="deleteSelected()">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          ` : ''}
        `;
      } else {
        const d = el.data();
        content.innerHTML = `
          <div class="field">
            <label>–ò—Å—Ç–æ—á–Ω–∏–∫</label>
            <input type="text" value="${d.source}" readonly>
          </div>
          <div class="field">
            <label>–¶–µ–ª—å</label>
            <input type="text" value="${d.target}" readonly>
          </div>
          <div class="field">
            <label>–¢–∏–ø —Å–≤—è–∑–∏</label>
            <select id="prop-edge-type" ${mode === 'view' ? 'disabled' : ''}>
              ${EDGE_TYPES.map(t => `<option value="${t}" ${d.type === t ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
          </div>
          ${mode === 'edit' ? `
          <div class="row">
            <button class="btn" onclick="applyEdgeChanges()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="deleteSelected()">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
          ` : ''}
        `;
      }
    }

    window.applyNodeChanges = function() {
      if (!selectedElement || !selectedElement.isNode()) return;
      selectedElement.data('label', document.getElementById('prop-label').value);
      selectedElement.data('status', document.getElementById('prop-status').value);
      selectedElement.data('rag_include', document.getElementById('prop-rag').checked);
      if (!selectedElement.data('props')) selectedElement.data('props', {});
      selectedElement.data('props').description = document.getElementById('prop-description').value;
      setDirty();
      updateStats();
    };

    window.applyEdgeChanges = function() {
      if (!selectedElement || !selectedElement.isEdge()) return;
      selectedElement.data('type', document.getElementById('prop-edge-type').value);
      setDirty();
    };

    window.deleteSelected = function() {
      if (!selectedElement) return;
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç?')) {
        selectedElement.remove();
        clearSelection();
        setDirty();
        updateStats();
      }
    };

    // === Filters ===
    function applyFilters() {
      const showStory = document.getElementById('filter-story').checked;
      const showSystem = document.getElementById('filter-system').checked;
      const showService = document.getElementById('filter-service').checked;
      const onlyRag = document.getElementById('filter-rag').checked;

      cy.nodes().forEach(node => {
        const layer = node.data('layer');
        const rag = node.data('rag_include');
        let visible = true;

        if (layer === 'story' && !showStory) visible = false;
        if (layer === 'system' && !showSystem) visible = false;
        if (layer === 'service' && !showService) visible = false;
        if (onlyRag && !rag) visible = false;

        node.toggleClass('hidden', !visible);
      });

      cy.edges().forEach(edge => {
        const source = cy.getElementById(edge.data('source'));
        const target = cy.getElementById(edge.data('target'));
        edge.toggleClass('hidden', source.hasClass('hidden') || target.hasClass('hidden'));
      });
    }

    // === Validation ===
    function runValidation() {
      const issues = [];
      const warnings = [];

      cy.nodes().forEach(node => {
        if (node.connectedEdges().length === 0) {
          warnings.push(`‚ö†Ô∏è Orphan: ${node.data('label')}`);
        }
      });

      const ids = new Set();
      cy.nodes().forEach(node => {
        if (ids.has(node.id())) {
          issues.push(`‚ùå –î—É–±–ª–∏–∫–∞—Ç ID: ${node.id()}`);
        }
        ids.add(node.id());
      });

      const layers = { story: 0, system: 0, service: 0 };
      cy.nodes().forEach(node => {
        const layer = node.data('layer');
        if (layers[layer] !== undefined) layers[layer]++;
      });
      Object.entries(layers).forEach(([layer, count]) => {
        if (count === 0) {
          warnings.push(`‚ö†Ô∏è –°–ª–æ–π ${layer} –ø—É—Å—Ç`);
        }
      });

      cy.nodes().filter('[type="Tool"]').forEach(node => {
        const hasDerivesFrom = cy.edges().some(e =>
          e.data('source') === node.id() && e.data('type') === 'derives_from'
        );
        if (!hasDerivesFrom) {
          warnings.push(`‚ö†Ô∏è Tool "${node.data('label')}" –±–µ–∑ derives_from`);
        }
      });

      const panel = document.getElementById('validation');
      if (issues.length > 0) {
        panel.className = 'validation error';
        panel.innerHTML = issues.map(i => `<div class="validation-item">${i}</div>`).join('');
      } else if (warnings.length > 0) {
        panel.className = 'validation warning';
        panel.innerHTML = warnings.map(w => `<div class="validation-item">${w}</div>`).join('');
      } else {
        panel.className = 'validation ok';
        panel.innerHTML = '<div class="validation-item">‚úÖ –ì—Ä–∞—Ñ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–µ–Ω</div>';
      }

      return { issues, warnings };
    }

    // === Export ===
    function exportGraphData() {
      return {
        schema: 'universe-graph.v0.1',
        meta: {
          project: 'extended-mind',
          exported_at: new Date().toISOString(),
        },
        nodes: cy.nodes().map(n => n.data()),
        edges: cy.edges().map(e => e.data()),
      };
    }

    function exportJSON() {
      const data = exportGraphData();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'universe-graph.json';
      a.click();
    }

    // === Draft ===
    function saveDraft() {
      const data = exportGraphData();
      localStorage.setItem('universe-graph-draft', JSON.stringify(data));
      dirty = false;
      document.getElementById('status').textContent = 'Draft —Å–æ—Ö—Ä–∞–Ω—ë–Ω';
      setTimeout(() => {
        document.getElementById('status').textContent = 'Universe Graph v0.3';
      }, 2000);
    }

    function loadDraft() {
      const saved = localStorage.getItem('universe-graph-draft');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          loadGraphData(data);
          document.getElementById('status').textContent = 'Draft –∑–∞–≥—Ä—É–∂–µ–Ω';
        } catch (e) {
          console.error('Failed to load draft', e);
          loadInitialData();
        }
      } else {
        loadInitialData();
      }
    }

    function loadGraphData(data) {
      cy.elements().remove();

      (data.nodes || []).forEach(node => {
        node.color = LAYER_COLORS[node.layer] || '#888';
        cy.add({ group: 'nodes', data: node });
      });

      (data.edges || []).forEach(edge => {
        cy.add({ group: 'edges', data: edge });
      });

      cy.layout({ name: 'cose', animate: false }).run();
    }

    function loadInitialData() {
      const initialNodes = [
        { id: 'project:extended-mind', label: 'extended-mind', type: 'Project', layer: 'system', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '–ú–µ—Ç–∞-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã' } },
        { id: 'project:vovaipetrova-core', label: 'vovaipetrova-core', type: 'Project', layer: 'system', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '–ö–æ–Ω—Ç–µ–Ω—Ç-–ø—Ä–æ–µ–∫—Ç (–∫–∞–Ω–æ–Ω)' } },
        { id: 'project:dream-graph', label: 'dream-graph', type: 'Project', layer: 'system', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–æ–≤' } },
        { id: 'project:vovaipetrova-site', label: 'vovaipetrova-site', type: 'Project', layer: 'system', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å' } },
        { id: 'project:minds-lorgnette', label: 'minds-lorgnette', type: 'Project', layer: 'system', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–Ω–∞–Ω–∏–π' } },
        { id: 'project:evoquant', label: 'evoquant', type: 'Project', layer: 'system', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç' } },
        { id: 'tool:console', label: 'extended-mind-console', type: 'Tool', layer: 'service', status: 'active', rag_include: true, rag_fields: ['description'], props: { description: '–†–µ–¥–∞–∫—Ç–æ—Ä—ã —Ç–∞–∫—Å–æ–Ω–æ–º–∏–π' } },
        { id: 'principle:backend-ecosystem', label: 'Backend = —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞', type: 'Principle', layer: 'system', status: 'stable', rag_include: true, rag_fields: ['label', 'description'], props: { description: '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∏–¥–Ω–∞ –∏ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞' } },
        { id: 'layer:story', label: 'Story', type: 'Layer', layer: 'system', status: 'stable', rag_include: false, rag_fields: [], props: { description: '–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç' } },
        { id: 'layer:system', label: 'System', type: 'Layer', layer: 'system', status: 'stable', rag_include: false, rag_fields: [], props: { description: '–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ' } },
        { id: 'layer:service', label: 'Service', type: 'Layer', layer: 'system', status: 'stable', rag_include: false, rag_fields: [], props: { description: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å' } },
      ];

      const initialEdges = [
        { id: 'edge:1', source: 'project:extended-mind', target: 'project:vovaipetrova-core', type: 'governs' },
        { id: 'edge:2', source: 'project:evoquant', target: 'project:vovaipetrova-core', type: 'feeds' },
        { id: 'edge:3', source: 'project:evoquant', target: 'project:extended-mind', type: 'feeds' },
        { id: 'edge:4', source: 'project:minds-lorgnette', target: 'project:extended-mind', type: 'derives_from' },
        { id: 'edge:5', source: 'tool:console', target: 'project:extended-mind', type: 'contains' },
        { id: 'edge:6', source: 'project:dream-graph', target: 'tool:console', type: 'uses' },
        { id: 'edge:7', source: 'project:vovaipetrova-site', target: 'project:vovaipetrova-core', type: 'uses' },
      ];

      loadGraphData({ nodes: initialNodes, edges: initialEdges });
    }

    // === Utils ===
    function setDirty() {
      dirty = true;
      runValidation();
    }

    function updateStats() {
      const nodes = cy.nodes().length;
      const edges = cy.edges().length;
      const rag = cy.nodes().filter('[rag_include]').length;
      document.getElementById('stats').textContent = `–£–∑–ª–æ–≤: ${nodes} | –°–≤—è–∑–µ–π: ${edges} | RAG: ${rag}`;
    }

    // === Init ===
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
