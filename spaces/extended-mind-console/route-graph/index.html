<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universe Graph Editor</title>
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0c;
      --panel: rgba(18, 18, 22, 0.95);
      --border: #2a2a2e;
      --text: #e8e6e3;
      --muted: #888;
      --accent: #7ee787;
      --node-default: #58a6ff;
      --node-selected: #facc15;
      --edge-default: #7ee787;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    #header {
      padding: 12px 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--muted);
    }

    /* Toolbar */
    #toolbar {
      padding: 8px 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Graph */
    #graph {
      flex: 1;
      background: var(--bg);
    }

    /* Footer */
    #footer {
      padding: 8px 20px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
    }

    /* Buttons */
    .btn {
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn.primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .btn.primary:hover {
      background: #9ef3a0;
    }

    .btn.active {
      background: var(--node-selected);
      color: #000;
      border-color: var(--node-selected);
    }

    /* Node label input */
    #node-label {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      font-size: 13px;
      width: 200px;
    }

    #node-label:focus {
      outline: none;
      border-color: var(--accent);
    }

    .separator {
      width: 1px;
      height: 24px;
      background: var(--border);
    }
  </style>
</head>

<body>
  <div id="app">
    <header id="header">
      <h1>Universe Graph Editor</h1>
      <div>
        <button class="btn" onclick="exportGraph()">Export JSON</button>
      </div>
    </header>

    <div id="toolbar">
      <button class="btn" id="add-node-btn" onclick="addNode()">+ Node</button>
      <button class="btn" id="add-edge-btn" onclick="startAddEdge()">+ Edge</button>
      <div class="separator"></div>
      <input type="text" id="node-label" placeholder="Node label..." onchange="updateSelectedLabel()">
      <div class="separator"></div>
      <button class="btn" onclick="deleteSelected()">Delete</button>
      <span style="flex:1"></span>
      <span id="status" style="color: var(--muted);">Click to select, drag to move</span>
    </div>

    <div id="graph"></div>

    <footer id="footer">
      <span id="stats">Nodes: 0 | Edges: 0</span>
      <span>Universe Graph — Source of Truth</span>
    </footer>
  </div>

  <script>
    window.cy = null;
    let cy = null;
    let selectedNode = null;
    let addingEdge = false;
    let edgeSource = null;

    // Graph data (глобально доступно для Gradio)
    window.graphData = {
      id: 'universe-graph',
      nodes: [],
      edges: []
    };
    // Alias for local use
    let graphData = window.graphData;

    document.addEventListener('DOMContentLoaded', init);

    function init() {
      window.cy = cy = cytoscape({
        container: document.getElementById('graph'),
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-valign': 'center',
              'text-halign': 'center',
              'background-color': 'var(--node-default)',
              'color': '#fff',
              'font-size': '14px',
              'width': 80,
              'height': 80,
              'border-width': 3,
              'border-color': '#3a7bd5'
            }
          },
          {
            selector: 'node:selected',
            style: {
              'border-width': 4,
              'border-color': 'var(--node-selected)'
            }
          },
          {
            selector: 'edge',
            style: {
              'width': 2,
              'line-color': 'var(--edge-default)',
              'target-arrow-color': 'var(--edge-default)',
              'target-arrow-shape': 'triangle',
              'curve-style': 'bezier'
            }
          }
        ],
        layout: { name: 'preset' }
      });

      cy.on('tap', 'node', onNodeTap);
      cy.on('tap', function (e) {
        if (e.target === cy) {
          clearSelection();
        }
      });

      // Load from localStorage
      const saved = localStorage.getItem('universe-graph');
      if (saved) {
        try {
          graphData = JSON.parse(saved);
          renderGraph();
        } catch (e) {
          console.error('Failed to load:', e);
        }
      }

      // If empty, add initial node
      if (graphData.nodes.length === 0) {
        addInitialNode();
      }

      updateStats();
    }

    function addInitialNode() {
      const node = {
        id: 'universe',
        label: 'Universe',
        position: { x: 400, y: 300 }
      };
      graphData.nodes.push(node);
      cy.add({
        group: 'nodes',
        data: { id: node.id, label: node.label },
        position: node.position
      });
      save();
    }

    window.renderGraph = function() {
      cy.elements().remove();

      graphData.nodes.forEach(node => {
        cy.add({
          group: 'nodes',
          data: { id: node.id, label: node.label },
          position: node.position || { x: Math.random() * 600 + 100, y: Math.random() * 400 + 100 }
        });
      });

      graphData.edges.forEach(edge => {
        cy.add({
          group: 'edges',
          data: { id: edge.id, source: edge.source, target: edge.target }
        });
      });
    }

    function addNode() {
      const id = 'node-' + Date.now();
      const label = 'Node ' + (graphData.nodes.length + 1);
      const position = { x: 200 + Math.random() * 400, y: 150 + Math.random() * 300 };

      const node = { id, label, position };
      graphData.nodes.push(node);

      cy.add({
        group: 'nodes',
        data: { id, label },
        position
      });

      save();
      updateStats();

      // Select new node
      cy.$('#' + id).select();
      onNodeTap({ target: cy.$('#' + id) });
    }

    function onNodeTap(e) {
      if (addingEdge) {
        if (!edgeSource) {
          edgeSource = e.target.id();
          setStatus('Select target node...');
        } else {
          const targetId = e.target.id();
          if (targetId !== edgeSource) {
            addEdge(edgeSource, targetId);
          }
          cancelAddEdge();
        }
        return;
      }

      selectedNode = e.target.id();
      const nodeData = graphData.nodes.find(n => n.id === selectedNode);
      if (nodeData) {
        document.getElementById('node-label').value = nodeData.label;
      }
      setStatus('Selected: ' + (nodeData?.label || selectedNode));
    }

    function clearSelection() {
      selectedNode = null;
      document.getElementById('node-label').value = '';
      cy.$(':selected').unselect();
      setStatus('Click to select, drag to move');
    }

    function updateSelectedLabel() {
      if (!selectedNode) return;

      const newLabel = document.getElementById('node-label').value;
      const nodeData = graphData.nodes.find(n => n.id === selectedNode);
      if (nodeData) {
        nodeData.label = newLabel;
        cy.$('#' + selectedNode).data('label', newLabel);
        save();
      }
    }

    function startAddEdge() {
      addingEdge = true;
      edgeSource = null;
      document.getElementById('add-edge-btn').classList.add('active');
      setStatus('Select source node...');
    }

    function cancelAddEdge() {
      addingEdge = false;
      edgeSource = null;
      document.getElementById('add-edge-btn').classList.remove('active');
      setStatus('Click to select, drag to move');
    }

    function addEdge(source, target) {
      // Check if edge already exists
      const exists = graphData.edges.some(e =>
        (e.source === source && e.target === target) ||
        (e.source === target && e.target === source)
      );
      if (exists) return;

      const id = 'edge-' + Date.now();
      const edge = { id, source, target };
      graphData.edges.push(edge);

      cy.add({
        group: 'edges',
        data: { id, source, target }
      });

      save();
      updateStats();
    }

    function deleteSelected() {
      if (!selectedNode) return;

      graphData.nodes = graphData.nodes.filter(n => n.id !== selectedNode);
      graphData.edges = graphData.edges.filter(e => e.source !== selectedNode && e.target !== selectedNode);

      cy.$('#' + selectedNode).remove();
      clearSelection();
      save();
      updateStats();
    }

    function exportGraph() {
      // Update positions
      graphData.nodes.forEach(node => {
        const cyNode = cy.$('#' + node.id);
        if (cyNode.length) {
          node.position = cyNode.position();
        }
      });

      const json = JSON.stringify(graphData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'universe-graph.json';
      a.click();

      URL.revokeObjectURL(url);
    }

    function save() {
      // Update positions before saving
      graphData.nodes.forEach(node => {
        const cyNode = cy.$('#' + node.id);
        if (cyNode.length) {
          node.position = cyNode.position();
        }
      });
      localStorage.setItem('universe-graph', JSON.stringify(graphData));
    }

    window.updateStats = function() {
      document.getElementById('stats').textContent =
        `Nodes: ${graphData.nodes.length} | Edges: ${graphData.edges.length}`;
    }

    function setStatus(text) {
      document.getElementById('status').textContent = text;
    }

    // Auto-save on node drag
    cy?.on('dragfree', 'node', save);
  </script>
</body>

</html>